# 📚 RAG 시스템 구조 및 작동 원리

## 🔄 전체 플로우

### 1단계: PDF 업로드 및 임베딩 생성

```
┌─────────────────┐
│  사용자         │
│  PDF 업로드     │
└────────┬────────┘
         │
         v
┌─────────────────────────────────────┐
│  텍스트 추출 (PyMuPDF/OCR)          │
│  - 메인 PDF: 기업 보고서            │
│  - 참고자료: 경쟁사/산업 분석       │
└────────┬────────────────────────────┘
         │
         v
┌─────────────────────────────────────┐
│  텍스트 청킹 (Chunking)             │
│  - 500 토큰 단위로 분할             │
│  - 50 토큰 overlap (컨텍스트 유지) │
│  - tiktoken 사용                    │
└────────┬────────────────────────────┘
         │
         v
┌─────────────────────────────────────┐
│  OpenAI Embeddings API              │
│  - Model: text-embedding-3-small    │
│  - Output: 1536차원 벡터            │
│  - 각 청크마다 임베딩 생성          │
└────────┬────────────────────────────┘
         │
         v
┌─────────────────────────────────────┐
│  Supabase Vector DB 저장            │
│  - document_embeddings 테이블       │
│  - pgvector 확장 사용               │
│  - HNSW 인덱스로 고속 검색          │
└─────────────────────────────────────┘
```

### 2단계: 보고서 생성 (RAG 활용)

```
┌─────────────────┐
│  사용자         │
│  보고서 요청    │
└────────┬────────┘
         │
         v
┌─────────────────────────────────────┐
│  쿼리 생성                          │
│  - "재무 정보"                      │
│  - "사업 구조"                      │
│  - "경쟁사 분석"                    │
│  - "리스크 요인" 등                 │
└────────┬────────────────────────────┘
         │
         v
┌─────────────────────────────────────┐
│  쿼리 임베딩 생성                   │
│  - OpenAI Embeddings API            │
│  - 쿼리도 1536차원 벡터로 변환      │
└────────┬────────────────────────────┘
         │
         v
┌─────────────────────────────────────┐
│  벡터 유사도 검색 (Cosine Sim)      │
│  - match_documents() RPC 함수       │
│  - 코사인 유사도 계산               │
│  - Top-K (상위 5~10개) 반환         │
└────────┬────────────────────────────┘
         │
         v
┌─────────────────────────────────────┐
│  컨텍스트 조합                      │
│  - 관련 문서 청크들 결합            │
│  - 최대 3000 토큰까지 조합          │
│  - 유사도 점수와 함께 정렬          │
└────────┬────────────────────────────┘
         │
         v
┌─────────────────────────────────────┐
│  GPT-4o 프롬프트 생성               │
│  - 추출된 키워드 데이터             │
│  - RAG 컨텍스트 (관련 문서 청크)   │
│  - 참고자료 텍스트                  │
│  - 보고서 작성 지침                 │
└────────┬────────────────────────────┘
         │
         v
┌─────────────────────────────────────┐
│  OpenAI GPT-4o-mini                 │
│  - 컨텍스트 기반 보고서 생성        │
│  - 출처 표시 자동 추가              │
│  - 11개 섹션 체계적 작성            │
└────────┬────────────────────────────┘
         │
         v
┌─────────────────┐
│  Word 문서 생성  │
│  다운로드 제공   │
└─────────────────┘
```

## 🗄️ 데이터베이스 스키마

### companies 테이블
```sql
┌────────────────┬──────────────┬─────────┐
│ Column         │ Type         │ Key     │
├────────────────┼──────────────┼─────────┤
│ id             │ BIGSERIAL    │ PRIMARY │
│ company_name   │ TEXT         │ INDEX   │
│ industry       │ TEXT         │         │
│ created_at     │ TIMESTAMPTZ  │ INDEX   │
│ updated_at     │ TIMESTAMPTZ  │         │
└────────────────┴──────────────┴─────────┘
```

### document_embeddings 테이블 (핵심!)
```sql
┌────────────────┬──────────────┬─────────────────┐
│ Column         │ Type         │ Key             │
├────────────────┼──────────────┼─────────────────┤
│ id             │ BIGSERIAL    │ PRIMARY         │
│ company_id     │ BIGINT       │ FOREIGN, INDEX  │
│ file_type      │ TEXT         │ INDEX           │
│ chunk_index    │ INTEGER      │                 │
│ chunk_text     │ TEXT         │                 │
│ embedding      │ VECTOR(1536) │ HNSW INDEX ⭐   │
│ token_count    │ INTEGER      │                 │
│ created_at     │ TIMESTAMPTZ  │                 │
└────────────────┴──────────────┴─────────────────┘
```

**HNSW 인덱스**: 
- Hierarchical Navigable Small World
- O(log N) 검색 속도
- 고차원 벡터 검색에 최적화

## 🔍 벡터 검색 알고리즘

### Cosine Similarity (코사인 유사도)

```
similarity = 1 - (vector_a <=> vector_b)

<=> : PostgreSQL 코사인 거리 연산자
```

**예시:**
```sql
SELECT 
    chunk_text,
    1 - (embedding <=> query_embedding) AS similarity
FROM document_embeddings
WHERE 1 - (embedding <=> query_embedding) > 0.5
ORDER BY embedding <=> query_embedding
LIMIT 5;
```

### 유사도 점수 해석

| 점수 범위 | 의미 |
|----------|------|
| 0.9 ~ 1.0 | 거의 동일한 의미 |
| 0.7 ~ 0.9 | 매우 관련성 높음 |
| 0.5 ~ 0.7 | 관련성 있음 |
| 0.3 ~ 0.5 | 약한 관련성 |
| 0.0 ~ 0.3 | 관련성 낮음 |

## 📊 성능 최적화

### 1. 청킹 전략
```python
max_tokens = 500      # 청크 크기
overlap_tokens = 50   # 겹침 영역

# 장점:
# - 500 토큰 ≈ 375 단어 ≈ 의미 단위 유지
# - 50 토큰 overlap으로 문맥 단절 방지
```

### 2. 배치 임베딩 생성
```python
# 10개씩 묶어서 진행 상황 표시
for i in range(0, len(chunks), 10):
    batch = chunks[i:i+10]
    create_embeddings(batch)
    show_progress(i)
```

### 3. 인덱싱 전략
```sql
-- HNSW 인덱스 생성
CREATE INDEX idx_embeddings_vector 
ON document_embeddings 
USING hnsw (embedding vector_cosine_ops);

-- 속도: Full Scan (O(N)) → HNSW (O(log N))
```

### 4. 쿼리 최적화
```python
# company_id로 먼저 필터링 (B-tree 인덱스)
# → 그 다음 벡터 검색 (HNSW 인덱스)

WHERE company_id = ? 
  AND (1 - (embedding <=> query)) > 0.5
```

## 🎯 RAG vs 기존 방식 비교

### ❌ 기존 방식 (단순 텍스트 저장)
```
쿼리: "재무 건전성"
└─> 키워드 매칭: "재무", "건전성"
    └─> 정확히 일치하는 문자열만 검색
        └─> 놓친 정보: "부채비율", "이자보상배율" 등
```

### ✅ RAG 방식 (임베딩 검색)
```
쿼리: "재무 건전성"
└─> 임베딩 변환: [0.23, -0.45, 0.78, ...]
    └─> 의미 유사도 검색
        └─> 발견 정보:
            - "부채비율 50% 양호"
            - "이자보상배율 3.5배"
            - "순운전자본 증가 추세"
            - "영업현금흐름 안정적"
```

## 💡 주요 개선 사항

### 1. 무제한 문서 처리
- **이전**: 50,000자 제한 → 잘림
- **현재**: 청킹으로 무제한 처리

### 2. 의미론적 검색
- **이전**: "매출" ≠ "Revenue"
- **현재**: 의미가 같으면 검색됨

### 3. 다중 문서 통합
- 메인 PDF + 여러 참고자료
- 통합 벡터 검색으로 종합 분석

### 4. 정확한 출처 추적
- 각 청크마다 출처 정보 저장
- 보고서에 자동 출처 표시

## 🔧 트러블슈팅

### 문제 1: 임베딩 생성 느림
**해결**: 청크 크기 조정 (500 → 1000 토큰)

### 문제 2: 검색 결과 정확도 낮음
**해결**: 유사도 임계값 조정 (0.5 → 0.7)

### 문제 3: 토큰 제한 초과
**해결**: RAG 컨텍스트 최대 토큰 제한 (3000)

## 📈 확장 가능성

### 1. 다중 언어 지원
- text-embedding-3-large 사용
- 100+ 언어 지원

### 2. 하이브리드 검색
- 벡터 검색 + 키워드 검색 결합
- BM25 + Embeddings

### 3. 파인튜닝
- 도메인 특화 임베딩 모델
- 금융/법률 문서 전문화

### 4. 실시간 업데이트
- 웹훅으로 신규 문서 자동 임베딩
- 증분 업데이트

## 🎓 참고 자료

- [OpenAI Embeddings](https://platform.openai.com/docs/guides/embeddings)
- [pgvector](https://github.com/pgvector/pgvector)
- [Supabase Vector](https://supabase.com/docs/guides/ai/vector-columns)
- [RAG 논문](https://arxiv.org/abs/2005.11401)
