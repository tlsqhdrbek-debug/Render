# 데이터 품질 검증 로그 시스템 가이드

## 📋 개요

이 시스템은 **OCR 추출 → LLM 데이터 추출 → 보고서 생성** 3단계 프로세스의 데이터 품질을 비교 분석하여, AI 모델들이 정확하게 데이터를 추출하고 보고서를 생성하는지 검증할 수 있습니다.

## 🎯 목적

사용자가 선택한 추출 키워드에 대해:
1. **OCR 원본 데이터** - Upstage Parse가 추출한 원본 텍스트와 표 구조
2. **LLM 추출 데이터** - GPT-4o-mini가 추출한 각 키워드별 데이터
3. **보고서 생성 결과** - 최종 생성된 보고서 내용

이 3가지를 나란히 비교하여 **OCR 정확도**와 **LLM 추론 정확도**를 검증합니다.

## 🗄️ Supabase 테이블 설정

### 1단계: SQL 파일 실행

`data_quality_logs_setup.sql` 파일을 Supabase SQL Editor에서 실행하세요:

```sql
-- Supabase Dashboard → SQL Editor → New Query → 파일 내용 붙여넣기 → Run
```

이 SQL 파일은 다음을 생성합니다:
- `data_quality_logs` 테이블
- 필요한 인덱스 (성능 최적화)
- RLS (Row Level Security) 정책

### 2단계: 테이블 구조 확인

생성된 테이블의 주요 컬럼:

| 컬럼명 | 설명 |
|--------|------|
| `selected_keywords` | 사용자가 선택한 추출 키워드 배열 |
| `ocr_raw_text` | Upstage OCR로 추출한 원본 텍스트 |
| `ocr_structured_data` | 표, 제목 등 구조화된 데이터 (JSONB) |
| `llm_extracted_data` | LLM이 추출한 각 키워드별 데이터 (JSONB) |
| `report_content` | 최종 생성된 보고서 전체 내용 |
| `extraction_success_rate` | 추출 성공률 (%) |

## 🔍 사용 방법

### 1. 데이터 추출 시 자동 로깅

앱에서 **"데이터 추출" 탭**에서 PDF를 업로드하고 추출을 실행하면:

```python
# 자동으로 실행됨 (코드 내부)
log_data_quality(
    selected_keywords=["매출액", "영업이익", "회사명", ...],
    ocr_raw_text="...",
    ocr_structured_data={...},
    llm_extracted_data={"매출액": "2,345억 원", ...},
    llm_extraction_time_ms=1523
)
```

로그가 Supabase의 `data_quality_logs` 테이블에 자동 저장됩니다.

### 2. 보고서 생성 시 자동 업데이트

**"보고서 생성" 탭**에서 보고서를 생성하면:

```python
# 기존 로그를 찾아서 보고서 데이터 추가
supabase_client.table("data_quality_logs").update({
    "report_generated": True,
    "report_content": "...",
    "report_generation_time_ms": 2456
}).eq("id", log_id).execute()
```

### 3. 관리자 대시보드에서 비교 분석

**관리자 탭 → "🔍 데이터 품질 비교"**에서:

1. **로그 목록 조회**
   - 최근 50개의 품질 로그 표시
   - 회사명, 사용자, 키워드 수, 성공률, 보고서 생성 여부 확인

2. **상세 비교 분석**
   - 로그를 선택하면 4개 탭으로 분석:
     - ① **선택된 키워드**: 사용자가 요청한 키워드 목록
     - ② **OCR 원본 데이터**: Upstage Parse 결과 (표, 텍스트)
     - ③ **LLM 추출 데이터**: GPT가 추출한 키워드별 값 (성공/실패 구분)
     - ④ **보고서 생성 결과**: 최종 생성된 보고서 전체

3. **종합 비교 요약**
   - OCR 단계: 표 인식 개수, 텍스트 길이
   - LLM 추출: 성공/실패 개수, 성공률
   - 보고서 생성: 생성 여부, 길이

## 📊 활용 예시

### 사례 1: OCR 정확도 검증

**문제**: "매출액" 키워드를 요청했는데 "정보 없음"이 나옴

**분석**:
1. **OCR 원본 데이터** 탭에서 표 구조 확인
   - 표가 제대로 인식되었는지 확인
   - "매출액"이라는 단어가 원본에 있는지 확인

2. **결과**:
   - ✅ 표가 인식되었고 "매출액: 2,345억 원"이 있음 → LLM 문제
   - ❌ 표가 인식 안 되었거나 텍스트가 깨짐 → OCR 문제

### 사례 2: LLM 추론 정확도 검증

**문제**: "영업이익률"을 요청했는데 잘못된 값이 나옴

**분석**:
1. **OCR 원본 데이터**에서 원본 값 확인: "23.5%"
2. **LLM 추출 데이터**에서 LLM이 추출한 값 확인: "23억 원"
3. **결론**: LLM이 "영업이익"과 "영업이익률"을 혼동 → 프롬프트 개선 필요

### 사례 3: 보고서 품질 검증

**문제**: 보고서에 없는 내용이 들어감

**분석**:
1. **LLM 추출 데이터**에서 원본 추출값 확인
2. **보고서 생성 결과**에서 최종 보고서 확인
3. **비교**: 추출 데이터에 없는 내용이 보고서에 있으면 LLM 환각(hallucination)

## 🎨 UI 특징

### 시각적 구분

- **성공한 데이터**: 초록색 배경 + 좌측 녹색 바
- **실패한 데이터**: 빨간색 배경 + 좌측 빨간색 바
- **키워드 태그**: 보라색 그라데이션 버튼

### 메트릭 카드

```
┌─────────────┬─────────────┬─────────────┬─────────────┐
│  회사명     │  키워드 수  │  추출 성공률│   표 인식   │
│  삼성전자   │     15      │    86.7%    │    3개      │
└─────────────┴─────────────┴─────────────┴─────────────┘
```

## 🔐 권한 관리

- **일반 사용자**: 데이터 추출만 가능 (로그 자동 생성)
- **관리자 (신봉규)**: 모든 품질 로그 조회 및 비교 가능

관리자 로그인:
1. "🔧 관리자" 탭 클릭
2. 비밀번호 입력 (기본값: `admin123`)
3. "🔍 데이터 품질 비교" 탭에서 분석

## 💡 품질 개선 방법

### OCR 정확도 개선

- PDF 품질이 낮은 경우: "표 구조 인식 모드" 활성화
- 스캔 문서: 고해상도로 재스캔

### LLM 추출 정확도 개선

- 프롬프트에 더 명확한 지침 추가
- Few-shot 예시 제공
- 구조화된 데이터 (표) 우선 활용하도록 프롬프트 수정

### 보고서 품질 개선

- 추출 데이터 품질을 먼저 개선
- 보고서 생성 프롬프트에 엄격한 제약 추가 (환각 방지)

## 📈 성능 모니터링

각 로그에는 처리 시간도 기록됩니다:

- `llm_extraction_time_ms`: LLM 추출 소요 시간
- `report_generation_time_ms`: 보고서 생성 소요 시간

성능 병목 지점을 파악하여 최적화할 수 있습니다.

## 🚀 다음 단계

1. ✅ Supabase 테이블 생성 (`data_quality_logs_setup.sql`)
2. ✅ 데이터 추출 실행 → 자동 로깅 확인
3. ✅ 관리자 대시보드에서 로그 확인
4. 📊 품질 문제 발견 → 개선 작업
5. 🔄 지속적 모니터링

## ❓ FAQ

**Q: 로그가 저장되지 않아요**
- Supabase 연결 확인
- `data_quality_logs` 테이블 생성 확인
- RLS 정책 확인

**Q: 너무 많은 로그가 쌓여요**
- 기본적으로 최근 50개만 표시
- 오래된 로그는 수동으로 삭제 가능

**Q: CSV로 다운로드 가능한가요?**
- 현재는 UI에서만 확인 가능
- 필요시 Supabase Dashboard에서 직접 쿼리 후 CSV 다운로드

---

**문의**: 관리자에게 문의하세요
