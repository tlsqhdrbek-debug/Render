# 🤖 AI를 활용한 데이터 품질 자동 분석 가이드

## 📋 개요

데이터 품질 로그를 TXT 파일로 내보내서 AI(ChatGPT, Claude 등)에게 첨부하면, OCR과 LLM의 문제점을 자동으로 분석하고 개선 방안을 제시받을 수 있습니다.

## 🔄 워크플로우

```
1. 데이터 추출 실행
   ↓
2. 관리자 → 데이터 품질 비교 → 로그 선택
   ↓
3. "📥 TXT 파일로 내보내기" 클릭
   ↓
4. AI에게 TXT 파일 첨부 + 분석 요청
   ↓
5. AI가 문제점 분석 + 개선안 제시
   ↓
6. 코드/프롬프트 수정
   ↓
7. 재테스트 → 성공률 비교
```

## 📥 TXT 파일 내보내기

### 1단계: 로그 선택

1. **관리자 탭** → **"🔍 데이터 품질 비교"**
2. 분석할 로그 선택 (회사명, 날짜, 성공률 확인)
3. 로그 상세 내용 확인

### 2단계: TXT 파일 다운로드

1. **"📥 TXT 파일로 내보내기"** 버튼 클릭
2. **"💾 다운로드"** 버튼으로 파일 저장
3. 파일명 형식: `quality_log_회사명_날짜.txt`

### TXT 파일 구조

```
================================================================================
데이터 품질 검증 로그 - AI 분석용
================================================================================

[기본 정보]
- 회사명: 삼성전자
- 사용자: 신봉규
- 작성일: 2025-12-24 15:30:00
- PDF 파일: samsung_report_2024.pdf
- PDF 페이지: 15페이지

[품질 메트릭]
- 추출 성공률: 86.7%
- 성공: 13개
- 실패: 2개
- OCR 표 인식: 3개

================================================================================
1. 선택된 추출 키워드
================================================================================
1. 매출액
2. 영업이익
3. 영업이익률
... (총 15개)

================================================================================
2. OCR 원본 데이터 (Upstage Parse)
================================================================================
[표 데이터 - 총 3개]

--- 표 1 (페이지 3) ---
재무 현황
항목        | 2024년      | 2025년
매출액      | 2,345억 원  | 1,018억 원
영업이익    | 551억 원    | 120억 원
영업이익률  | 23.5%       | 11.8%

[추출된 원본 텍스트]
삼성전자 사업보고서
2024년 회계연도
...

================================================================================
3. LLM 추출 데이터
================================================================================
[✅ 성공적으로 추출된 데이터 - 13개]
1. 매출액
   → 2024년 2,345억 원, 2025년 1,018억 원
2. 영업이익
   → 2024년 551억 원
...

[❌ 추출 실패 데이터 - 2개]
1. 주요 리스크
   → 정보 없음
2. 신규 사업
   → 정보 없음

================================================================================
AI 분석을 위한 질문
================================================================================
(파일에 포함된 분석 질문 가이드)
```

## 🤖 AI에게 분석 요청하는 방법

### ChatGPT 사용 예시

1. **파일 첨부**
   ```
   📎 quality_log_삼성전자_2025-12-24.txt
   ```

2. **프롬프트 예시**
   ```
   첨부한 TXT 파일은 PDF 데이터 추출 과정의 품질 로그입니다.
   
   다음을 분석해주세요:
   
   1. OCR 원본 데이터와 LLM 추출 데이터를 비교하여, LLM이 놓친 정보를 찾아주세요.
   2. 추출 실패 데이터(정보 없음)에 대해, OCR 원본에 실제로 정보가 있는지 확인해주세요.
   3. LLM이 잘못 추출한 값이 있는지 확인해주세요 (단위 오류, 키워드 혼동 등).
   4. 추출 성공률을 높이기 위한 구체적인 프롬프트 개선안을 제시해주세요.
   5. OCR 단계의 문제점이 있다면 지적해주세요.
   ```

### Claude 사용 예시

```
이 로그는 다음 3단계 파이프라인의 품질을 검증하기 위한 것입니다:
1. Upstage OCR → PDF에서 텍스트와 표 추출
2. GPT-4o-mini → 키워드별 데이터 추출
3. GPT-4o-mini → 보고서 생성

OCR 원본과 LLM 추출 결과를 비교하여:
- 데이터 손실 지점 파악
- LLM 추론 오류 발견
- 프롬프트 개선 방안 제시

상세히 분석해주세요.
```

## 📊 AI 분석 결과 예시

### AI가 발견할 수 있는 문제들:

#### 1. **OCR 원본에 있는데 LLM이 놓친 경우**

**AI 분석:**
```
문제: "영업이익률" 추출 실패

OCR 원본 확인:
- 표 1에 "영업이익률 | 23.5% | 11.8%" 명확히 존재

LLM 추출 결과:
- "정보 없음"

원인 추정:
- LLM이 표 데이터를 제대로 파싱하지 못함
- 또는 "영업이익률"과 "영업이익"을 구분하지 못함

개선안:
프롬프트에 다음 추가:
"영업이익률은 '%' 단위의 비율입니다. 영업이익(금액)과 혼동하지 마세요."
```

#### 2. **LLM이 잘못 추출한 경우**

**AI 분석:**
```
문제: "순이익" 잘못 추출

OCR 원본: "순이익 120억 원"
LLM 추출: "120백만 원"

원인: 단위 변환 오류

개선안:
프롬프트에 "금액 단위는 원문 그대로 유지하세요. 억 → 백만 변환하지 마세요."
```

#### 3. **프롬프트 개선 제안**

**AI 제안:**
```python
# 현재 프롬프트 (문제점)
prompt = f"""다음 문서에서 {field_name}을(를) 찾아주세요."""

# 개선된 프롬프트
prompt = f"""
다음 문서에서 "{field_name}"을(를) 정확히 찾아 추출하세요.

**중요 지침:**
1. 표 데이터가 있으면 반드시 표에서 먼저 찾으세요.
2. "{field_name}"과 유사한 다른 키워드(예: 영업이익 vs 영업이익률)와 혼동하지 마세요.
3. 숫자는 원문의 단위를 그대로 유지하세요 (억 원, %, 천만 원 등).
4. 여러 기간 데이터가 있으면 모두 표시하세요.
5. 정보가 전혀 없으면 "정보 없음"만 응답하세요.
"""
```

## 🔧 개선 프로세스

### 1. AI 분석 결과 검토

```markdown
AI가 찾은 문제점:
✅ 1. "영업이익률" OCR에 있음 → LLM 놓침
✅ 2. "순이익" 단위 변환 오류
✅ 3. 표 데이터 우선 처리 안 됨
```

### 2. 코드 수정

AI 제안을 바탕으로 `streamlit_app.py` 수정:

```python
# extract_all_keywords_batch() 함수의 프롬프트 수정
def extract_all_keywords_batch(text, field_names, structured_data=None):
    # ... 기존 코드 ...
    
    prompt = f"""다음 문서에서 아래 항목들에 해당하는 정보를 찾아서 정확하게 추출하세요.

**중요 지침:**
1. **표 데이터가 있으면 무조건 표에서 먼저 찾으세요** ⭐ (AI 제안 반영)
2. **숫자는 원문 단위 그대로** (억 원 → 백만 원 변환 금지) ⭐ (AI 제안 반영)
3. **유사 키워드 구분** (영업이익 ≠ 영업이익률) ⭐ (AI 제안 반영)
4. 여러 기간 데이터는 모두 표시
5. 정보 없으면 "정보 없음"만 응답

{context_info}

추출할 항목:
{fields_list}
"""
```

### 3. 재테스트

1. 같은 PDF로 다시 데이터 추출
2. 새로운 품질 로그 생성
3. 성공률 비교:
   ```
   수정 전: 86.7% (13/15)
   수정 후: 93.3% (14/15) ✅ 개선됨!
   ```

### 4. 반복

- 여전히 실패하는 키워드가 있으면 다시 AI 분석
- 점진적으로 성공률 향상

## 💡 AI 분석 활용 팁

### 1. **구체적인 질문하기**

❌ 나쁜 예:
```
이 로그를 분석해줘
```

✅ 좋은 예:
```
"영업이익률" 키워드가 추출 실패했는데, OCR 원본에 이 정보가 있는지 확인하고,
있다면 왜 LLM이 찾지 못했는지 분석해줘. 그리고 프롬프트를 어떻게 수정하면
이 문제를 해결할 수 있는지 구체적으로 제안해줘.
```

### 2. **여러 로그 비교 분석**

```
첨부한 3개 TXT 파일은 같은 회사의 서로 다른 PDF입니다.
공통적으로 실패하는 키워드 패턴을 찾아서,
시스템적인 문제인지 PDF별 문제인지 구분해주세요.
```

### 3. **단계별 분석 요청**

```
1단계: 먼저 OCR 품질만 평가해주세요 (표 인식률, 텍스트 정확도)
2단계: LLM 추출 품질 평가
3단계: 종합 개선안 제시
```

## 📈 성과 측정

### 개선 전후 비교

| 지표 | 개선 전 | 개선 후 | 변화 |
|------|---------|---------|------|
| 추출 성공률 | 86.7% | 96.0% | +9.3% ✅ |
| 표 인식 활용률 | 60% | 95% | +35% ✅ |
| 단위 오류 | 3건 | 0건 | -3건 ✅ |
| 키워드 혼동 | 2건 | 0건 | -2건 ✅ |

### 로그 이력 관리

```
2025-12-24: 초기 테스트 - 86.7% 성공률
2025-12-24: AI 분석 후 프롬프트 개선 - 93.3%
2025-12-25: 표 우선 처리 로직 추가 - 96.0%
2025-12-25: 키워드 명확화 - 98.7%
```

## 🎯 고급 활용

### 1. **A/B 테스트**

```
같은 PDF로 2가지 프롬프트 버전 테스트:
- 버전 A: 기존 프롬프트
- 버전 B: AI 제안 프롬프트

TXT 파일 2개를 AI에게 첨부:
"어느 프롬프트가 더 정확한지 비교하고, 
 버전 B의 장단점을 분석해주세요."
```

### 2. **자동화 파이프라인**

```python
# 미래 확장: API로 자동 분석
def auto_analyze_quality_log(txt_file_path):
    """TXT 파일을 OpenAI API로 자동 분석"""
    with open(txt_file_path, 'r', encoding='utf-8') as f:
        log_content = f.read()
    
    response = openai_client.chat.completions.create(
        model="gpt-4",
        messages=[
            {"role": "system", "content": "데이터 품질 분석 전문가"},
            {"role": "user", "content": f"다음 로그를 분석하고 개선안 제시:\n\n{log_content}"}
        ]
    )
    
    return response.choices[0].message.content
```

### 3. **벤치마크 데이터셋**

```
"정답" 데이터셋 구축:
1. 수동으로 정확한 추출 결과 작성
2. AI 추출 결과와 비교
3. 정확도 점수 산출
4. 지속적 개선
```

## 🚨 주의사항

### 1. **개인정보 보호**

TXT 파일에 민감한 정보가 포함될 수 있습니다:
- 회사 기밀 정보
- 재무 데이터
- 내부 전략

**대책:**
- 익명화된 테스트 데이터 사용
- 로컬 LLM 사용 (ollama 등)
- 민감 정보 마스킹 처리

### 2. **AI 제안의 맹신 금지**

AI 제안도 검증 필요:
- ✅ 제안을 이해하고 적용
- ✅ 테스트로 효과 확인
- ❌ 무조건 수용 금지

### 3. **버전 관리**

```bash
git commit -m "AI 분석 기반 프롬프트 개선 - 성공률 86% → 96%"
git tag v1.2-quality-improved
```

## 📚 추가 자료

- [DATA_QUALITY_GUIDE.md](DATA_QUALITY_GUIDE.md) - 품질 로그 기본 가이드
- [IMPLEMENTATION_SUMMARY.md](IMPLEMENTATION_SUMMARY.md) - 구현 상세
- [streamlit_app.py](streamlit_app.py) - 소스 코드

---

## ✅ 체크리스트

- [ ] TXT 파일 다운로드 성공
- [ ] AI에게 파일 첨부
- [ ] 구체적인 분석 질문 작성
- [ ] AI 분석 결과 검토
- [ ] 코드/프롬프트 수정
- [ ] 재테스트 및 성공률 비교
- [ ] 개선 사항 문서화

**이제 AI의 도움으로 데이터 품질을 자동으로 개선할 수 있습니다!** 🚀
